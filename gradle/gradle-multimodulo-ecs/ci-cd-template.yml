steps:
#-----------   CI ------------------    
# Construir el microservicio 
- task: Gradle@3
  displayName: 'Build $(microservice)'
  inputs:
    gradleWrapperFile: 'gradlew'  
    workingDirectory: '.'  
    tasks: ':$(microservice):clean :$(microservice):build'
    options: '-x test ' 
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '$(javaVersion)'  
    jdkArchitectureOption: 'x64'
    sonarQubeRunAnalysis: false
    spotBugsAnalysis: false

- script: ls -R $(System.DefaultWorkingDirectory)
  displayName: 'List all files'

#Tarea para copiar los artefactos necesarios
- task: CopyFiles@2
  displayName: 'Copy JAR to Artifact Directory'
  inputs:
    SourceFolder: '$(System.DefaultWorkingDirectory)/$(microservice)/build/libs'
    Contents: '**/*.jar'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    CleanTargetFolder: true

#Tarea para publicar el artefacto
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: JAR'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'JAR'
    publishLocation: 'Container'

#-----------   CD ------------------   
# Iniciar sesión en Amazon ECR
- task: AWSCLI@1
  displayName: 'ECR Login'
  inputs:
    awsCredentials: #'service-connection-general' # Recuerda poner el ServiceConection que corresponde
    regionName: $(awsRegion)
    awsCommand: 'ecr'
    awsSubCommand: 'get-login-password'
    awsArguments: '--region $(awsRegion)'

# Construir la imagen Docker
- task: Docker@2
  displayName: 'Build Docker Image'
  inputs:
    repository: '$(ecrRegistry)/$(imageName)'
    command: 'build'
    Dockerfile: '$(dockerFileName)'
    buildContext: '.'
    tags: '$(imageTag)'

# Listar las imágenes de Docker (opcional)
- script: |
    docker images
  displayName: 'List Docker Images'

# Publicar la imagen a ECR
- task: ECRPushImage@1
  displayName: 'ECR Push Image'
  inputs:
    awsCredentials: #'service-connection-general' # Recuerda poner el ServiceConection que corresponde
    regionName: 'us-east-1'
    imageSource: 'imagename'
    sourceImageName: '$(ecrRegistry)/$(imageName)'
    sourceImageTag: '$(imageTag)'
    repositoryName: '$(imageName)'
    pushTag: '$(imageTag)'

# Configurar el cliente ECS
- task: AWSCLI@1
  displayName: 'Configure ECS'
  inputs:
    awsCredentials: #'service-connection-general' # Recuerda poner el ServiceConection que corresponde
    regionName: 'us-east-1'
    awsCommand: 'ecs'
    awsSubCommand: 'update-service'
    awsArguments: '--cluster $(clustername) --service $(SERVICE) --force-new-deployment'

